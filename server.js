import "dotenv/config";
import express from "express";
import mongoose from "mongoose";
import cors from "cors";
import User from "./models/User.js";

const app = express();

const FIRST_DEPOSIT_REWARD_USDT = Number(process.env.FIRST_DEPOSIT_REWARD_USDT || 1);

app.use(cors({
  origin: [
    "https://onex-gifts.vercel.app"                     // ‚Üê –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
  ],
  methods: ["GET", "POST", "OPTIONS"],
  allowedHeaders: ["Content-Type", "x-telegram-id"],
  optionsSuccessStatus: 204
}));

// ‚úÖ –ß—Ç–æ–±—ã preflight-–∑–∞–ø—Ä–æ—Å—ã OPTIONS –Ω–µ –ª–æ–º–∞–ª–∏ –±—ç–∫–µ–Ω–¥
app.options("*", cors());

// ‚úÖ –ü–∞—Ä—Å–∏–º JSON –≤ body
app.use(express.json({ limit: "1mb" }));

// ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
mongoose.connect(process.env.MONGODB_URI)
  .then(() => console.log("‚úÖ MongoDB connected"))
  .catch((err) => console.error("‚ùå MongoDB error:", err));

// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞
app.get("/ping", (_, res) => res.json({ ok: true }));
app.get("/", (_, res) => res.type("text/plain").send("OK"));



// ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ –≤ Octys)
app.post("/register-user", async (req, res) => {
  try {
    const { telegramId, username, firstName, lastName, photoUrl, ref } = req.body;

    if (!telegramId) {
      return res.status(400).json({ error: "telegramId is required" });
    }

    let user = await User.findOne({ telegramId });

    // –ï—Å–ª–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º
    if (!user) {
      const newUser = new User({
        telegramId,
        username: username || null,
        firstName: firstName || null,
        lastName: lastName || null,
        photoUrl: photoUrl || null,
        balance: 0,
        referredBy: ref || null,
      });
      await newUser.save();
      console.log(`‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω: ${telegramId}`);
      return res.json({ ok: true, user: newUser });
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
    user.username = username || user.username;
    user.firstName = firstName || user.firstName;
    user.lastName = lastName || user.lastName;
    user.photoUrl = photoUrl || user.photoUrl;
    await user.save();

    console.log(`üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω: ${telegramId}`);
    res.json({ ok: true, user });
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", err);
    res.status(500).json({ ok: false, error: "Server error" });
  }
});

// ‚úÖ –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ñ—Ä–æ–Ω—Ç—É)
app.get("/get-user", async (req, res) => {
  try {
    const { telegramId } = req.query;
    if (!telegramId) return res.status(400).json({ error: "telegramId is required" });

    const user = await User.findOne({ telegramId });
    if (!user) return res.status(404).json({ error: "User not found" });

    res.json({ ok: true, user });
  } catch (err) {
    res.status(500).json({ ok: false, error: "Server error" });
  }
});

// GET –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç –∂–∏–≤ (–≤–µ—Ä–Ω—ë—Ç 405)
app.get("/tasks/channel/verify", (_req, res) => res.status(405).json({ ok:false, error:"Use POST" }));

// POST: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞—á–∏—Å–ª—è–µ—Ç TON
app.post("/tasks/channel/verify", async (req, res) => {
  try {
    const { telegramId } = req.body || {};
    if (!telegramId) return res.status(400).json({ ok:false, error: "telegramId is required" });

    const user = await User.findOne({ telegramId: String(telegramId) });
    if (!user) return res.status(404).json({ ok:false, error: "User not found" });

    if (user.tasks?.channelSubscribed) {
      return res.json({ ok:true, status:"already_claimed", user });
    }

    // Bot API
    const url = `https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/getChatMember`;
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ chat_id: process.env.CHANNEL_ID, user_id: String(telegramId) })
    });
    const data = await resp.json();
    if (!data.ok) return res.status(502).json({ ok:false, error:"Bot API error", details:data });

    const status = data.result?.status;  // 'creator'|'administrator'|'member'|'restricted'|'left'|'kicked'
    const isSub = new Set(["creator","administrator","member","restricted"]).has(status);
    if (!isSub) return res.json({ ok:true, status:"not_subscribed" });

    // –ê—Ç–æ–º–∞—Ä–Ω–æ ‚Äî —á—Ç–æ–±—ã –Ω–µ –Ω–∞—á–∏—Å–ª–∏—Ç—å –¥–≤–∞–∂–¥—ã –Ω–∞ –≥–æ–Ω–∫–∞—Ö
    const upd = await User.updateOne(
      { telegramId: String(telegramId), "tasks.channelSubscribed": { $ne: true } },
      { $inc: { balanceTon: Number(process.env.CHANNEL_REWARD_TON || 0) },
        $set: { "tasks.channelSubscribed": true } }
    );

    if (upd.modifiedCount === 0) {
      return res.json({ ok:true, status:"already_claimed" });
    }

    const fresh = await User.findOne({ telegramId: String(telegramId) });
    return res.json({ ok:true, status:"rewarded", reward:{ ton:Number(process.env.CHANNEL_REWARD_TON||0) }, user:fresh });
  } catch (e) {
    console.error("/tasks/channel/verify error:", e);
    res.status(500).json({ ok:false, error:"Server error" });
  }
});

// ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥
app.post("/withdraw/create", async (req, res) => {
  try {
    const { telegramId, amount, address } = req.body || {};
    if (!telegramId) return res.status(400).json({ ok:false, error: "telegramId is required" });

    const amt = Number(amount);
    if (!Number.isFinite(amt) || amt <= 0) {
      return res.status(400).json({ ok:false, error: "Invalid amount" });
    }

    // –ª—ë–≥–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è TRC20 (–∞–¥—Ä–µ—Å–∞ Tron –≤ Base58, –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å T, –¥–ª–∏–Ω–∞ 34)
    const addr = String(address || "").trim();
    const isTron = /^T[1-9A-HJ-NP-Za-km-z]{33}$/.test(addr);
    if (!isTron) {
      return res.status(400).json({ ok:false, error: "Invalid TRC20 address" });
    }

    const user = await User.findOne({ telegramId: String(telegramId) });
    if (!user) return res.status(404).json({ ok:false, error: "User not found" });

    const order = {
      _id: new mongoose.Types.ObjectId(),
      amount: amt,                 // —Å—É–º–º–∞ –≤ USDT (–∫–∞–∫ —Ç—ã –∏ —Ö–æ—á–µ—à—å)
      currency: "USDT",
      address: addr,
      status: "–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ",       // –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
      createdAt: new Date()
    };

    await User.updateOne(
      { telegramId: String(telegramId) },
      { $push: { withdrawOrders: { $each: [order], $position: 0 } } } // –¥–æ–±–∞–≤–∏–º –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–∏–≤–∞
    );

    return res.json({ ok: true, order });
  } catch (e) {
    console.error("POST /withdraw/create error:", e);
    res.status(500).json({ ok:false, error:"Server error" });
  }
});

// ‚úÖ –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
app.get("/withdraw/list", async (req, res) => {
  try {
    const { telegramId } = req.query || {};
    if (!telegramId) return res.status(400).json({ ok:false, error: "telegramId is required" });

    const user = await User.findOne({ telegramId: String(telegramId) }).lean();
    if (!user) return res.status(404).json({ ok:false, error: "User not found" });

    const orders = Array.isArray(user.withdrawOrders) ? user.withdrawOrders : [];
    res.json({ ok:true, orders });
  } catch (e) {
    console.error("GET /withdraw/list error:", e);
    res.status(500).json({ ok:false, error:"Server error" });
  }
});

// ===== Partner redirectors (open our domain inside TG, then 302 to partner)
const JETTON_REF = process.env.JETTON_REF || "https://jetton.direct/cgc494NciBw?click_id={click_id}";
const MOSTBET_REF = process.env.MOSTBET_REF || "https://vs66cd75semb.com/zAuF?sub1={telegramId}";

app.get("/go/jetton", async (req, res) => {
  try {
    const { userId } = req.query;
    if (!userId) return res.status(400).type("text/plain").send("userId required");

    // —Å–≤–æ–π click_id, —á—Ç–æ–±—ã Jetton –≤–µ—Ä–Ω—É–ª –µ–≥–æ –∫–∞–∫ click_slug
    const clickId = `tg_${userId}_${Date.now()}`;
    const url = JETTON_REF.replace("{click_id}", encodeURIComponent(clickId));

    // –ø–æ–º–µ—á–∞–µ–º –∫–ª–∏–∫, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å—Ç–±—ç–∫
    await User.updateOne(
      { telegramId: String(userId) },
      {
        $addToSet: { "traffic.clickIds": clickId },
        $set: { "traffic.lastOutbound": { provider: "jetton", clickId, at: new Date() } }
      }
    ).catch(() => {});

    return res.redirect(302, url);
  } catch (e) {
    console.error("GET /go/jetton error:", e);
    res.status(500).type("text/plain").send("redirect error");
  }
});

app.get("/go/mostbet", async (req, res) => {
  try {
    const { userId } = req.query;
    if (!userId) return res.status(400).type("text/plain").send("userId required");

    const url = MOSTBET_REF.replace("{telegramId}", encodeURIComponent(String(userId)));

    await User.updateOne(
      { telegramId: String(userId) },
      { $set: { "traffic.lastOutbound": { provider: "mostbet", at: new Date() } } }
    ).catch(() => {});

    return res.redirect(302, url);
  } catch (e) {
    console.error("GET /go/mostbet error:", e);
    res.status(500).type("text/plain").send("redirect error");
  }
});

app.get("/postback/jetton", async (req, res) => {

  console.log("[POSTBACK] raw:", req.originalUrl);
  console.log("[POSTBACK] query:", req.query);
  try {
    const {
      player_id,             // –∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π id –∏–≥—Ä–æ–∫–∞ (–º–æ–∂–µ—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞—à–∏–º)
      player_telegram_id,    // Telegram ID (—Å—Ç—Ä–æ–∫–∞, –±—ã–≤–∞–µ—Ç "0", –µ—Å–ª–∏ –Ω–µ—Ç)
      promo_slug,
      click_slug,
      action,                // register | first_deposit | deposit | withdraw
      amount_usd,            // —á–∏—Å–ª–æ –≤ USD
      tx_id                  // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏)
    } = req.query;

    // 1) –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ Telegram ID
    const telegramId = (player_telegram_id && player_telegram_id !== "0")
      ? String(player_telegram_id)
      : null;

    let user = telegramId
      ? await User.findOne({ telegramId })
      : null;

    // 2) Fallback: –µ—Å–ª–∏ Telegram ID –Ω–µ—Ç, —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º –ø–æ click_slug (–º—ã –∑–∞—Ä–∞–Ω–µ–µ –∫–ª–∞–¥—ë–º —Å–≤–æ–π click_id –≤ traffic.clickIds)
    if (!user && click_slug) {
      user = await User.findOne({ "traffic.clickIds": click_slug });
      if (user && telegramId) {
        await User.updateOne({ _id: user._id }, { telegramId });
      }
    }

    // 3) –ï—Å–ª–∏ –Ω–∞—à–ª–∏ ‚Äî –∑–∞–ø–∏—à–µ–º —Ç—Ä–∞—Ñ–∏–∫-–º–µ—Ç–∫–∏
    if (user) {
      const trafficUpdate = {};
      if (promo_slug) trafficUpdate["traffic.promo_slug"] = promo_slug;
      if (click_slug) {
        trafficUpdate["traffic.click_slug"] = click_slug;
        trafficUpdate.$addToSet = { ...(trafficUpdate.$addToSet || {}), "traffic.clickIds": click_slug };
      }
      if (Object.keys(trafficUpdate).length) {
        await User.updateOne({ _id: user._id }, trafficUpdate);
      }
    }

    // 4) –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 200, —á—Ç–æ–±—ã Jetton –Ω–µ –ø–µ—Ä–µ—Å—Ç–∞–ª —Å–ª–∞—Ç—å
    if (!user) {
      return res.status(200).send("OK: user_not_found");
    }

    // 5) –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ tx_id
    if (tx_id && user.deposits?.lastTxId === tx_id) {
      return res.status(200).send("OK: duplicate_tx_id");
    }

    // 6) –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —Ç–æ–ª—å–∫–æ –¥–µ–ø–æ–∑–∏—Ç—ã
    const isDepositEvent = action === "first_deposit" || action === "deposit";
    if (!isDepositEvent) {
      return res.status(200).send("OK");
    }

    const usd = Number(amount_usd || 0);

    const update = {
      "deposits.lastTxId": tx_id || null,
      $inc: { "deposits.count": 1, "deposits.totalUsd": usd }
    };

    // 7) –ú–µ—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞
    const isFirstByAction = action === "first_deposit";
    if (isFirstByAction && !user.deposits.firstDepositAt) {
      update["deposits.firstDepositAt"] = new Date();
    }

    // 8) –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø–µ—Ä–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å)
    if (isFirstByAction && !user.rewards?.firstDepositGranted) {
      update.$inc = update.$inc || {};
      update.$inc.balanceTon = FIRST_DEPOSIT_REWARD_USDT; // USDT-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ —Ç–≤–æ–µ–π –º–æ–¥–µ–ª–∏
      update["rewards.firstDepositGranted"] = true;
      update["rewards.firstDepositAmount"]  = FIRST_DEPOSIT_REWARD_USDT;
    }

    await User.updateOne({ _id: user._id }, update);

    return res.status(200).send("OK");
  } catch (e) {
    console.error("postback error:", e);
    return res.status(200).send("ERROR"); // Jetton –æ–±—ã—á–Ω–æ –Ω–µ —Ä–µ—Ç—Ä–∞–∏—Ç –ø–æ 500
  }
});

// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ –∏–∑ –ë–î –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ü–†–û–í–ï–†–ò–¢–¨ (Jetton/Mostbet/–∏ –¥—Ä.)
// GET /check-casino-deposit?userId=123&minUsd=5
app.get("/check-casino-deposit", async (req, res) => {
  try {
    const { userId, minUsd } = req.query;
    if (!userId) return res.status(400).json({ ok:false, error: "userId is required" });

    const user = await User.findOne({ telegramId: String(userId) });
    if (!user) return res.status(404).json({ ok:false, error: "User not found" });

    const count = Number(user.deposits?.count || 0);
    const totalUsd = Number(user.deposits?.totalUsd || 0);
    const firstDepositAt = user.deposits?.firstDepositAt || null;

    // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è minUsd: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º "5", "5$", "5 –¥–æ–ª", "5,5"
    let threshold = null;
    if (minUsd !== undefined && minUsd !== null && String(minUsd).trim() !== "") {
      const cleaned = String(minUsd).trim().replace(",", ".").replace(/[^0-9.]/g, "");
      const parsed = parseFloat(cleaned);
      if (Number.isFinite(parsed) && parsed > 0) threshold = parsed;
    }

    let deposited = false;
    let reason = "";

    if (threshold !== null) {
      deposited = totalUsd >= threshold;
      if (!deposited) reason = `threshold_not_met: totalUsd=${totalUsd}, required=${threshold}`;
    } else {
      // –ë–µ–∑ –ø–æ—Ä–æ–≥–∞: –ª—é–±–æ–π —Ñ–∞–∫—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –¥–ª—è ¬´–ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞¬ª
      deposited = count > 0 || totalUsd > 0 || Boolean(firstDepositAt);
      if (!deposited) reason = "no_deposit";
    }

    return res.json({ ok:true, deposited, count, totalUsd, firstDepositAt, minUsd: threshold, reason });
  } catch (e) {
    console.error("‚ùå /check-casino-deposit error:", e);
    return res.status(500).json({ ok:false, error: "Server error" });
  }
});


// ‚úÖ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 8080;
app.listen(PORT, "0.0.0.0", () => {
  console.log(`üöÄ Server running on port ${PORT}`);
});